name: Deploy Akamai EdgeWorker

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22'
      - name: Install Akamai CLI and EdgeWorkers CLI
        run: |
          # Set up GOPATH
          export GOPATH=$HOME/go
          mkdir -p $GOPATH
    
          # Download the binary
          git clone https://github.com/akamai/cli.git $GOPATH/src/github.com/akamai/cli
          cd $GOPATH/src/github.com/akamai/cli
          go build -o akamai cli/main.go
          chmod +x akamai
          sudo mv akamai /usr/local/bin/
          export PATH=$PATH:/usr/local/bin/
    
          # Verify installation
          akamai --version
    
          # Install EdgeWorkers package
          akamai install edgeworkers  
          
      - name: Configure Akamai credentials
        run: |
          touch ~/.edgerc
          cat > ~/.edgerc << EOF
          [default]
          host = ${{ secrets.AKAMAI_HOST }}
          client_token = ${{ secrets.AKAMAI_CLIENT_TOKEN }}
          client_secret = ${{ secrets.AKAMAI_CLIENT_SECRET }}
          access_token = ${{ secrets.AKAMAI_ACCESS_TOKEN }}
          EOF
          
      - name: Create tarball package
        run: |
          EDGEWORKER_ID=$(jq -r '.edgeworker.id' ew.json)
          VERSION=$(jq -r '.edgeworker.version' ew.json)
          tar -czvf "${EDGEWORKER_ID}_${VERSION}.tgz" main.js bundle.json
          ls -la "${EDGEWORKER_ID}_${VERSION}.tgz"
          
      - name: Upload EdgeWorker
        run: |
          EDGEWORKER_ID=$(jq -r '.edgeworker.id' ew.json)
          VERSION=$(jq -r '.edgeworker.version' ew.json)
          TARBALL="${EDGEWORKER_ID}_${VERSION}.tgz"
          akamai edgeworkers upload --bundle $TARBALL $EDGEWORKER_ID --accountkey ${{ secrets.ASK }}
          
      - name: Activate EdgeWorker on staging
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          EDGEWORKER_ID=$(jq -r '.edgeworker.id' ew.json)
          VERSION=$(jq -r '.edgeworker.version' ew.json)
          echo "EW ID - "
          echo $EDGEWORKER_ID
          akamai edgeworkers activate $EDGEWORKER_ID STAGING --accountkey ${{ secrets.ASK }}
          
      - name: Activate EdgeWorker on production
        if: github.event_name == 'workflow_dispatch'
        run: |
          EDGEWORKER_ID=$(jq -r '.edgeworker.id' ew.json)
          VERSION=$(jq -r '.edgeworker.version' ew.json)
          akamai edgeworkers activate $EDGEWORKER_ID PRODUCTION --accountkey ${{ secrets.ASK }}
